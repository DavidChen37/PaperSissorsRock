<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="text-center">
      <h1>ROUND 1</h1>
      <a onclick="restart()"><u>restart</u></a>
    </div>
    <script type="text/javascript">
      var ran, botchoice, userchoice, camresult;
      var userscore = 0;
      var botscore = 0;

      const URL = "https://teachablemachine.withgoogle.com/models/cxUexDxHK/";

      let model,
        webcam,
        labelContainer,
        maxPredictions,
        bottle,
        me,
        result,
        resultchange,
        preditedchoice;

      // Load the image model and setup the webcam
      async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        // load the model and metadata
        // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
        // or files from your local hard drive
        // Note: the pose library adds "tmImage" object to your window (window.tmImage)
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // Convenience function to setup a webcam
        const flip = true; // whether to flip the webcam
        webcam = new tmImage.Webcam(200, 200, flip); // width, height, flip
        await webcam.setup(); // request access to the webcam

        nextround();
      }
      function myfunc() {
        console.log("wait");
        document.getElementById("webcam-container").style.display = "none";
        clicked(preditedchoice);
      }
      async function offit() {
        console.log("off");
        setTimeout(webcam.pause, 5000);
        setTimeout(myfunc, 5000);
      }
      async function loop() {
        webcam.update(); // update the webcam frame
        await predict();
        window.requestAnimationFrame(loop);
      }
      function nextround() {
        console.log("on");
        document.getElementById("webcam-container").style.display = "block";
        webcam.play();
        offit();
        window.requestAnimationFrame(loop);

        // append elements to the DOM
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        labelContainer = document.getElementById("label-container");
        for (let i = 0; i < maxPredictions; i++) {
          // and class labels
          labelContainer.appendChild(document.createElement("div"));
        }
      }
      // run the webcam image through the image model
      async function predict() {
        // predict can take in an image, video or canvas html element
        const prediction = await model.predict(webcam.canvas);
        for (let i = 0; i < maxPredictions; i++) {
          const classPrediction =
            prediction[i].className +
            ": " +
            prediction[i].probability.toFixed(2);
          if (prediction[i].className === "Paper") {
            if (prediction[i].probability.toFixed(2) != bottle) {
              resultchange = true;
              //   console.log(
              //     prediction[i].className +
              //       ": " +
              //       prediction[i].probability.toFixed(2)
              //   );
            }
            bottle = prediction[i].probability.toFixed(2);
          } else if (prediction[i].className === "Rock") {
            if (prediction[i].probability.toFixed(2) != me) {
              resultchange = true;
              //   console.log(
              //     prediction[i].className +
              //       ": " +
              //       prediction[i].probability.toFixed(2)
              //   );
            }
            me = prediction[i].probability.toFixed(2);
          }
          if (resultchange === true) {
            resultchange = false;
            if (bottle > me) {
              console.log("[Paper]" + bottle + ">" + "Rock" + me);
              preditedchoice = "paper";
              //bottle code
            } else {
              console.log("[Rock]" + me + ">" + "Paper" + bottle);
              preditedchoice = "rock";
              //me code
            }
          }
          labelContainer.childNodes[i].innerHTML = classPrediction;
        }
      }

      function restart() {
        userscore = 0;
        botscore = 0;
        refresh();
      }

      function updateResults() {
        document.getElementById("displayResults").innerHTML =
          "Result was a " + result;
        return result;
      }

      function botrandomchoice() {
        ran = Math.floor(Math.random() * (4 - 1) + 1);
        if (ran == 1) {
          return "paper";
        } else if (ran == 2) {
          return "scissors";
        } else if (ran == 3) {
          return "rock";
        }
      }
      function botclicked(choice) {
        document.getElementById("botSelection").innerHTML =
          "Bot selected " + choice;
        document.getElementById("botscissors").firstChild.src =
          "assets/img/" + choice + ".JPG";
        document.getElementById("botpaper").style.display = "none";
        document.getElementById("botrock").style.display = "none";
      }
      function clicked(choice) {
        console.log("user choice was " + choice);
        botchoice = botrandomchoice();
        botclicked(botchoice);
        userchoice = choice;
        document.getElementById("mySelection").innerHTML =
          "You selected " + userchoice;
        document.getElementById("scissors").firstChild.src =
          "assets/img/" + userchoice + ".JPG";
        document.getElementById("paper").style.display = "none";
        document.getElementById("rock").style.display = "none";
        result = validation(botchoice, userchoice);
        console.log("player " + result + "s...");
        updateResults();
        console.log("user:" + userscore + ",botscore" + botscore);
        if (userscore >= 3) {
          console.log("userscore=" + userscore + " so user wins");
          document.getElementById("displayResults").innerHTML = "User wins";
          webcam.stop;
        } else if (botscore >= 3) {
          console.log("botscore=" + botscore + " so bot wins");
          document.getElementById("displayResults").innerHTML = "Bot wins";
          webcam.stop;
        } else {
          setTimeout(nextround, 1000);
        }
      }

      function validation(bot, player) {
        if (player == "paper") {
          if (bot == "scissors") {
            botscore++;
            document.getElementById("botScoreDisplay").innerHTML =
              "Score - " + botscore;
            return "lose";
          } else if (bot == "paper") {
            return "draw";
          } else if (bot == "rock") {
            userscore++;
            document.getElementById("playerScoreDisplay").innerHTML =
              "Score - " + userscore;

            return "win";
          }
        } else if (player == "scissors") {
          if (bot == "scissors") {
            return "draw";
          } else if (bot == "paper") {
            userscore++;
            document.getElementById("playerScoreDisplay").innerHTML =
              "Score - " + userscore;

            return "win";
          } else if (bot == "rock") {
            botscore++;
            document.getElementById("botScoreDisplay").innerHTML =
              "Score - " + botscore;

            return "lose";
          }
        } else if (player == "rock") {
          if (bot == "scissors") {
            userscore++;
            document.getElementById("playerScoreDisplay").innerHTML =
              "Score - " + userscore;

            return "win";
          } else if (bot == "paper") {
            botscore++;
            document.getElementById("botScoreDisplay").innerHTML =
              "Score - " + botscore;
            return "lose";
          } else if (bot == "rock") {
            return "draw";
          }
        }
      }
    </script>
    <div class="container">
      <div>Teachable Machine Image Model</div>
      <button type="button" onclick="init()">Start</button>
      <button type="button" onclick="offit()">Stop</button>
      <div id="webcam-container"></div>
      <div id="label-container"></div>
      <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
      <div class="row">
        <div class="col-sm-6" style="text-align: center">
          <h3 id="playerScoreDisplay">Score - 0</h3>
          <div>You</div>
          <div class="row" style="width: 400px; margin: auto">
            <div class="col-sm-4" style="text-align: center">
              <a href="#" onclick="clicked('paper')" id="paper" class="mine">
                <img
                  id="imga"
                  src="assets/img/paper.JPG"
                  style="height: 150px; width: 100px"
                />
              </a>
            </div>
            <div class="col-sm-4" style="text-align: center">
              <a
                href="#"
                onclick="clicked('scissors')"
                id="scissors"
                class="mine"
                ><img
                  src="assets/img/scissors.JPG"
                  style="height: 150px; width: 100px"
                />
              </a>
            </div>
            <div class="col-sm-4" style="text-align: center">
              <a href="#" onclick="clicked('rock')" id="rock" class="mine"
                ><img
                  src="assets/img/rock.JPG"
                  style="height: 150px; width: 100px"
                />
              </a>
            </div>
          </div>
          <div id="mySelection">Need To make a selection</div>
        </div>
        <div class="col-sm-6" style="text-align: center">
          <h3 id="botScoreDisplay">Score - 0</h3>
          <div>opponent</div>
          <div class="row" style="width: 400px; margin: auto">
            <div class="col-sm-4" style="text-align: center">
              <a href="#" id="botpaper"
                ><img
                  src="assets/img/paper.JPG"
                  style="height: 150px; width: 100px"
                />
              </a>
            </div>
            <div class="col-sm-4" style="text-align: center">
              <a href="#" id="botscissors"
                ><img
                  src="assets/img/scissors.JPG"
                  style="height: 150px; width: 100px"
                />
              </a>
            </div>
            <div class="col-sm-4" style="text-align: center">
              <a href="#" id="botrock"
                ><img
                  src="assets/img/Rock.JPG"
                  style="height: 150px; width: 100px"
                />
              </a>
            </div>
          </div>
          <div id="botSelection">Bot has selected</div>
        </div>
      </div>
      <div class="results">
        <h2 id="displayResults" style="text-align: center"></h2>
      </div>
    </div>
  </body>
</html>
